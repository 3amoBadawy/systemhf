class u{constructor(){this.currentStep=1,this.selectedCategory=null,this.selectedCategoryName=null,this.selectedProduct=null,this.selectedProductName=null,this.selectedProductPrice=null,this.selectedProductImage=null,this.selectedProducts=[],this.currentPage=1,this.totalPages=1,this.perPage=12,this.products=[],this.categories=[],this.init()}init(){this.loadData(),this.setupEventListeners(),this.initializeSelect2()}async loadData(){try{const e=await fetch("/api/categories");this.categories=await e.json();const n=await fetch("/api/products");this.products=await n.json(),this.renderCategories()}catch(e){console.error("Error loading data:",e)}}setupEventListeners(){const e=document.getElementById("product-search");e&&e.addEventListener("input",i=>this.searchProducts(i.target.value));const n=document.getElementById("quantity"),t=document.getElementById("unit_price"),o=document.getElementById("discount");n&&n.addEventListener("input",()=>this.calculateTotal()),t&&t.addEventListener("input",()=>this.calculateTotal()),o&&o.addEventListener("input",()=>this.calculateTotal());const s=document.getElementById("invoice_discount");s&&s.addEventListener("input",()=>this.updateTotals())}initializeSelect2(){typeof $<"u"&&$.fn.select2&&($("#customer_id").select2({theme:"bootstrap-5",placeholder:"ابحث بالاسم أو رقم الهاتف...",allowClear:!0,width:"100%",language:"ar",dir:"rtl"}),$("#customer_id").on("change",e=>{const n=e.target.value;n?this.showCustomerInfo(n):this.hideCustomerInfo()}))}renderCategories(){const e=document.getElementById("step-1-content");if(!e)return;const n=e.querySelector(".categories-grid")||e;n&&(n.innerHTML=this.categories.map(t=>`
            <div 
                id="category-${t.id}"
                onclick="invoiceCreator.selectCategory(${t.id}, '${t.name_ar}')" 
                class="category-card"
            >
                <div class="category-icon">🛋️</div>
                <div class="category-name">${t.name_ar}</div>
                <div class="category-count">${this.getProductsCountByCategory(t.id)} منتج</div>
            </div>
        `).join(""))}getProductsCountByCategory(e){return this.products.filter(n=>n.category_id==e).length}selectCategory(e,n){console.log("Selecting category:",e,n),document.querySelectorAll(".category-card").forEach(o=>{o.classList.remove("selected")});const t=document.getElementById(`category-${e}`);t&&t.classList.add("selected"),this.selectedCategory=e,this.selectedCategoryName=n,this.updateStepStatus(1,"completed"),this.showProductsByCategory(e),this.nextStep()}async showProductsByCategory(e){const n=document.getElementById("step-2-content"),t=document.getElementById("products-grid");if(!n||!t)return;n.style.display="block",document.getElementById("step-1-content").style.display="none";const o=document.getElementById("selected-category-name");o&&(o.textContent=this.selectedCategoryName),await this.loadProductsForCategory(e),this.updateStepStatus(2,!0)}async loadProductsForCategory(e){try{const t=await(await fetch(`/products/category/${e}?per_page=${this.perPage}&page=${this.currentPage}`)).json();this.renderProducts(t.data||t),this.updatePagination(t.pagination);const o=document.getElementById("products-count");o&&t.pagination&&(o.textContent=t.pagination.total)}catch(n){console.error("Error loading products:",n),this.showError("حدث خطأ أثناء تحميل المنتجات")}}renderProducts(e){const n=document.getElementById("products-grid");if(n){if(!e||e.length===0){n.innerHTML=`
                <div class="no-products">
                    <div class="no-products-icon">📦</div>
                    <div class="no-products-text">لا توجد منتجات في هذه الفئة</div>
                </div>
            `;return}n.innerHTML=e.map(t=>`
            <div 
                class="product-card"
                onclick="invoiceCreator.selectProduct(${t.id}, '${t.name_ar}', ${t.price}, '${t.main_image||""}')"
            >
                <div class="product-image">
                    ${t.main_image?`<img src="/storage/${t.main_image}" alt="${t.name_ar}">`:'<div class="product-placeholder">📦</div>'}
                </div>
                <div class="product-info">
                    <div class="product-name">${t.name_ar}</div>
                    ${t.description_ar?`<div class="product-description">${t.description_ar.substring(0,60)}${t.description_ar.length>60?"...":""}</div>`:""}
                    <div class="product-price">${t.price} ج.م</div>
                </div>
            </div>
        `).join("")}}selectProduct(e,n,t,o){console.log("Selecting product:",e,n,t),this.selectedProduct=e,this.selectedProductName=n,this.selectedProductPrice=t,this.selectedProductImage=o,this.updateStepStatus(2,"completed"),this.showProductDetails(),this.nextStep()}showProductDetails(){const e=document.getElementById("step-3-content");if(!e)return;e.style.display="block",document.getElementById("step-2-content").style.display="none";const n=document.getElementById("selected-product-name");n&&(n.textContent=this.selectedProductName);const t=document.getElementById("selected-product-image");t&&(this.selectedProductImage?t.innerHTML=`<img src="/storage/${this.selectedProductImage}" alt="${this.selectedProductName}">`:t.innerHTML='<div class="product-placeholder">📦</div>');const o=document.getElementById("unit_price");o&&(o.value=this.selectedProductPrice),this.calculateTotal(),this.updateStepStatus(3,!0)}calculateTotal(){const e=parseInt(document.getElementById("quantity")?.value)||0,n=parseFloat(document.getElementById("unit_price")?.value)||0,t=parseFloat(document.getElementById("discount")?.value)||0,o=e*n-t,s=document.getElementById("total");s&&(s.value=o.toFixed(2))}addProductToInvoice(){const e=parseInt(document.getElementById("quantity")?.value)||0,n=parseFloat(document.getElementById("unit_price")?.value)||0,t=parseFloat(document.getElementById("discount")?.value)||0;if(!this.selectedProduct||!e||!n){this.showError("يرجى تحديد المنتج والكمية والسعر");return}const o=e*n-t,s={id:this.selectedProduct,name:this.selectedProductName,image:this.selectedProductImage,quantity:e,unit_price:n,discount:t,total:o};this.selectedProducts.push(s),this.displaySelectedProducts(),this.resetProductSelection(),this.showStep(1)}resetProductSelection(){this.selectedProduct=null,this.selectedProductName=null,this.selectedProductImage=null,this.selectedCategory=null,this.selectedCategoryName=null;const e=document.getElementById("quantity"),n=document.getElementById("unit_price"),t=document.getElementById("discount"),o=document.getElementById("total");e&&(e.value=1),n&&(n.value=""),t&&(t.value=0),o&&(o.value=""),document.querySelectorAll(".category-card").forEach(s=>{s.classList.remove("selected")}),this.updateStepStatus(1,!1),this.updateStepStatus(2,!1),this.updateStepStatus(3,!1)}displaySelectedProducts(){const e=document.getElementById("selected-products-list"),n=document.getElementById("selected-products");if(!(!e||!n)){if(this.selectedProducts.length===0){n.style.display="none";return}n.style.display="block",e.innerHTML=this.selectedProducts.map((t,o)=>`
            <div class="selected-product-item">
                <div class="product-image">
                    ${t.image?`<img src="/storage/${t.image}" alt="${t.name}">`:'<div class="product-placeholder">📦</div>'}
                </div>
                <div class="product-details">
                    <div class="product-name">${t.name}</div>
                    <div class="product-quantity">الكمية: ${t.quantity} × ${t.unit_price} ج.م</div>
                </div>
                <div class="product-actions">
                    <div class="product-total">${t.total} ج.م</div>
                    <button type="button" onclick="invoiceCreator.removeProduct(${o})" class="remove-btn">حذف</button>
                </div>
            </div>
        `).join(""),this.updateTotals()}}removeProduct(e){this.selectedProducts.splice(e,1),this.displaySelectedProducts()}updateTotals(){const e=this.selectedProducts.reduce((c,d)=>c+d.total,0),n=this.selectedProducts.reduce((c,d)=>c+d.discount,0),t=parseFloat(document.getElementById("invoice_discount")?.value)||0,o=e-t,s=document.getElementById("subtotal"),i=document.getElementById("total-discount"),r=document.getElementById("invoice-discount"),a=document.getElementById("grand-total");s&&(s.textContent=e.toFixed(2)),i&&(i.textContent=n.toFixed(2)),r&&(r.textContent=t.toFixed(2)),a&&(a.textContent=o.toFixed(2))}searchProducts(e){document.querySelectorAll("#products-grid .product-card").forEach(t=>{const o=t.querySelector(".product-name")?.textContent.toLowerCase()||"",s=t.querySelector(".product-description")?.textContent.toLowerCase()||"";o.includes(e.toLowerCase())||s.includes(e.toLowerCase())?t.style.display="block":t.style.display="none"})}nextStep(){this.currentStep<3&&this.showStep(this.currentStep+1)}prevStep(){this.currentStep>1&&this.showStep(this.currentStep-1)}showStep(e){document.getElementById("step-1-content").style.display="none",document.getElementById("step-2-content").style.display="none",document.getElementById("step-3-content").style.display="none";const n=document.getElementById(`step-${e}-content`);n&&(n.style.display="block"),this.currentStep=e,this.updateStepStatus(e,!0)}updateStepStatus(e,n){const t=document.getElementById(`step-${e}`);if(!t)return;const o=t.querySelector("div");o&&(n===!0?(t.style.borderColor="#667eea",t.style.background="#ebf8ff",o.style.background="#667eea",o.style.color="white"):n==="completed"?(t.style.borderColor="#48bb78",t.style.background="#f0fff4",o.style.background="#48bb78",o.style.color="white"):(t.style.borderColor="#e2e8f0",t.style.background="white",o.style.background="#e2e8f0",o.style.color="#4a5568"))}updatePagination(e){if(!e)return;this.totalPages=e.last_page;const n=document.getElementById("pagination");if(!n)return;if(this.totalPages<=1){n.style.display="none";return}n.style.display="block";const t=document.getElementById("page-info"),o=document.getElementById("prev-page"),s=document.getElementById("next-page");t&&(t.textContent=`صفحة ${this.currentPage} من ${this.totalPages}`),o&&(o.disabled=this.currentPage<=1),s&&(s.disabled=this.currentPage>=this.totalPages)}async loadPage(e){e<1||e>this.totalPages||!this.selectedCategory||(this.currentPage=e,await this.loadProductsForCategory(this.selectedCategory))}prevPage(){this.currentPage>1&&this.loadPage(this.currentPage-1)}nextPage(){this.currentPage<this.totalPages&&this.loadPage(this.currentPage+1)}showCustomerInfo(e){const t=document.getElementById("customer_id")?.querySelector(`option[value="${e}"]`),o=document.getElementById("customer_info");if(t&&o){const s=t.getAttribute("data-phone")||"",i=t.getAttribute("data-address")||"",r=t.getAttribute("data-governorate")||"",a=document.getElementById("customer_phone"),c=document.getElementById("customer_address"),d=document.getElementById("customer_governorate");a&&(a.textContent=s),c&&(c.textContent=i||"غير محدد"),d&&(d.textContent=r||"غير محدد"),o.style.display="block"}}hideCustomerInfo(){const e=document.getElementById("customer_info");e&&(e.style.display="none")}showError(e){alert(e)}prepareFormSubmission(){const e=document.querySelector("form");e&&this.selectedProducts.forEach((n,t)=>{const o=`
                <input type="hidden" name="products[${t}][product_id]" value="${n.id}">
                <input type="hidden" name="products[${t}][quantity]" value="${n.quantity}">
                <input type="hidden" name="products[${t}][unit_price]" value="${n.unit_price}">
                <input type="hidden" name="products[${t}][discount]" value="${n.discount}">
                <input type="hidden" name="products[${t}][total]" value="${n.total}">
            `;e.insertAdjacentHTML("beforeend",o)})}}document.addEventListener("DOMContentLoaded",function(){window.invoiceCreator=new u;const l=document.querySelector("form");l&&l.addEventListener("submit",function(t){window.invoiceCreator.prepareFormSubmission()});const e=document.getElementById("prev-page"),n=document.getElementById("next-page");e&&e.addEventListener("click",()=>window.invoiceCreator.prevPage()),n&&n.addEventListener("click",()=>window.invoiceCreator.nextPage())});
